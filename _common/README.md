The common code is located here.